<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Piclean - Load Backup</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <style>
    * {
      font-family: "Quicksand", sans-serif;
    }
    /* Responsive tweaks for mobile */
    @media (max-width: 768px) {
      .hero.is-one-quarter .hero-body { padding: 1.25rem 1rem; }
      input#picrew-id.input { width: 100%; }
      .button.is-fullwidth { display: block; width: 100%; }
      /* Make crew boxes stack and buttons full width */
      #crews { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
      #crews .box { display: flex; flex-direction: column; align-items: stretch; }
      #crews .box .button { width: 100%; margin-top: 0.5rem; }
      #crews .box a.has-text-weight-bold { display: block; margin-bottom: 0.5rem; }
    }
    /* Small improvements for narrow but not tiny screens */
    @media (min-width: 769px) and (max-width: 1024px) {
      #crews { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body>
  <link rel="stylesheet" href="nav.css">
  <nav class="navbar site-navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="favicon.ico" alt="Piclean Logo" width="28" height="28" />
        <span class="ml-2 has-text-weight-bold">Piclean</span>
      </a>
      <a role="button" class="navbar-burger" id="navToggle" aria-label="menu" aria-expanded="false" data-target="navMenu" title="Menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>
    <div class="navbar-menu" id="navMenu">
      <div class="navbar-end">
        <a class="navbar-item" href="search.html"><span class="icon-text">
            <span class="icon"><i class="fas fa-search"></i></span>
            <span class="">Search</span>
          </span></a>
        <a class="navbar-item" href="discovery.html"><span class="icon-text">
            <span class="icon"><i class="fas fa-th-large"></i></span>
            <span class="">Discovery</span>
          </span></a>
        <a class="navbar-item" href="local.html"><span class="icon-text">
            <span class="icon"><i class="fas fa-upload"></i></span>
            <span class="">Load Backups</span>
          </span></a>
        <a class="navbar-item" href="progress.html"><span class="icon-text">
            <span class="icon"><i class="fas fa-info-circle"></i></span>
            <span class="">About</span>
          </span></a>
      </div>
    </div>
  </nav>
  <div class="hero is-dark is-one-quarter">
    <div class="hero-body">
      <div class="container has-text-centered">
        <section class="section">
          <div class="content">
            <p class="is-size-1 has-text-weight-bold">Load Custom Picrew Backup</p>
          </div>
        </section>
      </div>
    </div>
  </div>
  <div class="container mt-3">
    <input type="text" id="picrew-id" class="input is-medium mb-3 is-fullwidth" placeholder="Enter Picrew ID (Can be anything)" />
    <button id="file-load" class="button is-primary is-fullwidth">
      <span class="icon">
        <i class="fas fa-upload"></i>
      </span>
      <span>Load Backup File (Zip Or JSON)</span>
    </button>
    <div id="file-info" class="mt-3"></div>
    <hr />
    <div class="fixed-grid has-5-cols">
      <div class="grid" id="crews"></div>
    </div>
  </div>
  <script src="nav.js" defer></script>
  <script src="scripts/jszip.min.js"></script>
  <script src="scripts/localforage.min.js"></script>
  <script>
    document.getElementById("file-load").addEventListener("click", () => {
      if (document.getElementById("picrew-id").value !== "") {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".zip,.json";
        input.onchange = async (event) => {
          const file = event.target.files[0];
          if (file) {
            document.getElementById("file-info").innerText = `Loaded file: ${file.name} (${(
              file.size /
              1024 /
              1024
            ).toFixed(2)} MB) for picrew ID: ${document.getElementById("picrew-id").value}`;
            if (file.type == "application/json") {
              var tempJson = await file.text();
              try {
                var tempdata = JSON.parse(tempJson);
                tempdata.isLonely = true;
                var zip = new JSZip();
                zip.file("data.json", JSON.stringify(tempdata));
                var zipBlob = await zip.generateAsync({ type: "blob" });
              } catch (e) {
                alert("Invalid JSON file.");
                return;
              }
            } else if (file.type == "application/zip" || file.name.endsWith(".zip")) {
              var zipBlob = file;
              JSZip.loadAsync(zipBlob).then(async (zip) => {
                const dataFile = zip.file("data.json");
                if (dataFile) {
                  // data.json file exists
                } else {
                  alert("data.json file not found in the zip.");
                  return;
                }
                if (zip.folder(/cdn.picrew.me/).length > 0) {
                  // Images folder exists
                } else {
                  alert("Warning: No images folder found in the zip. Images will attempt to load directly from picrew");
                  zip.file("data.json").async("string").then((content) => {
                    try {
                      const data = JSON.parse(content);
                      data.isLonely = true;
                      const newZip = new JSZip();
                      newZip.file("data.json", JSON.stringify(data));
                      newZip.generateAsync({ type: "blob" }).then(async (newZipBlob) => {
                        zipBlob = newZipBlob;
                      });
                    } catch (e) {
                      alert("Invalid data.json file.");
                      return;
                    }
                  });
                }
              });
              
            } else {
              alert("Please upload a valid .zip or .json file.");
              return;
            }
            await localforage.setItem("picrew-backup-" + document.getElementById("picrew-id").value, zipBlob);
            loadCrews();
          }

        };
        input.click();
      } else {
        alert("Please enter a Picrew ID first.");
      }
    });
    function downloadBackup(picrewId) {
      localforage.getItem("picrew-backup-" + picrewId).then((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `picrew-backup-${picrewId}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }
    function deleteBackup(picrewId, button) {
      if (confirm(`Are you sure you want to delete the backup for Picrew ID: ${picrewId}?`)) {
        localforage.removeItem("picrew-backup-" + picrewId).then(() => {
          button.parentElement.remove();
        });
      }
    }
    function loadCrews() {
      document.getElementById("crews").innerHTML = "";
      localforage.keys().then((keys) => {
        keys.forEach((key) => {
          if (key.startsWith("picrew-backup-")) {
            const picrewId = key.replace("picrew-backup-", "");
            const crewDiv = document.createElement("div");
            crewDiv.className = "box has-text-centered mx-2 my-2";
            crewDiv.innerHTML = `
            <a class="has-text-weight-bold" href="player.html?id=${picrewId}">Picrew ID: ${picrewId}</a>
            <button class="button my-2 is-link is-small" onclick="downloadBackup('${picrewId}')">
              <span class="icon">
                <i class="fas fa-download"></i>
              </span>
              <span>Download Backup</span>
            </button>
            <button class="button my-2 is-danger is-small" onclick="deleteBackup('${picrewId}', this)">
              <span class="icon">
                <i class="fas fa-trash"></i>
              </span>
              <span>Delete Backup</span>
            </button>
          `;
            document.getElementById("crews").appendChild(crewDiv);
          }
        });
      });
    }
    loadCrews();
  </script>
</body>

</html>